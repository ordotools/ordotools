<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordotools Master List</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@3.0.0/build/pure-min.css">
    <link rel="stylesheet" href="https://unpkg.com/purecss@3.0.0/build/grids-responsive-min.css">
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            background: #f4f5f7;
            color: #333;
        }
        header {
            background: #1f4b99;
            color: #fff;
            padding: 1.5rem 1rem;
        }
        header .pure-button {
            background: #fff;
            color: #1f4b99;
        }
        main {
            max-width: 1100px;
            margin: 0 auto;
            padding: 1.5rem 1rem 3rem;
        }
        .controls {
            background: #fff;
            border: 1px solid #d8d8d8;
            border-radius: 6px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        .controls h2 {
            margin-top: 0;
            font-size: 1.2rem;
        }
        .filters {
            margin-top: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        .filters label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.3rem;
        }
        .filters select, .filters input {
            width: 100%;
        }
        .results {
            background: #fff;
            border: 1px solid #d8d8d8;
            border-radius: 6px;
            padding: 1.25rem;
        }
        .results h2 {
            margin: 0 0 1rem;
            font-size: 1.2rem;
        }
        .table-wrapper {
            overflow-x: auto;
        }
        table {
            width: 100%;
        }
        .placeholder {
            padding: 2rem 0;
            text-align: center;
            color: #666;
        }
        .meta-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            color: #555;
        }
        .pagination {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1.25rem;
        }
        .pagination button {
            min-width: 5rem;
        }
        .badge {
            display: inline-block;
            padding: 0.1rem 0.5rem;
            border-radius: 999px;
            font-size: 0.8rem;
            background: #e2e8f0;
        }
        .rank-label {
            font-weight: 600;
        }
        .loading {
            text-align: center;
            padding: 2rem 0;
            color: #666;
        }
    </style>
</head>
<body>
    <header>
        <div class="pure-g">
            <div class="pure-u-1 pure-u-md-3-4">
                <h1 style="margin: 0 0 0.35rem;">Ordotools Master List</h1>
                <p style="margin: 0; max-width: 38em;">
                    Review records across every table. Switch the dataset and adjust the filters to focus on the data you need.
                </p>
            </div>
            <div class="pure-u-1 pure-u-md-1-4" style="text-align: right; align-self: center; margin-top: 1rem;">
                <div style="display:flex; gap:0.5rem; justify-content:flex-end; flex-wrap:wrap;">
                    <a class="pure-button pure-button-primary" href="/">Data Entry Forms</a>
                    <a class="pure-button pure-button-primary" href="/feasts">Feast Manager</a>
                </div>
            </div>
        </div>
    </header>
    <main>
        <section class="controls">
            <h2>Filters</h2>
            <div class="filters">
                <div>
                    <label for="dataset-select">Table</label>
                    <select id="dataset-select">
                        <option value="temporal">Temporal feasts</option>
                        <option value="sanctoral">Sanctoral feasts</option>
                        <option value="dioceses">Dioceses</option>
                        <option value="countries">Countries</option>
                        <option value="translations">Translations</option>
                    </select>
                </div>
                <form id="filters-temporal" class="filter-form" data-type="temporal">
                    <label for="temporal-language">Language</label>
                    <select id="temporal-language" name="language" data-role="language-select">
                        <option value="la">la</option>
                    </select>
                    <button type="submit" class="pure-button pure-button-primary" style="margin-top: 0.6rem;">Apply</button>
                </form>
                <form id="filters-sanctoral" class="filter-form" data-type="sanctoral" hidden>
                    <label for="sanctoral-diocese">Diocese</label>
                    <select id="sanctoral-diocese" name="diocese" data-role="diocese-select">
                        <option value="roman">Roman</option>
                    </select>
                    <label for="sanctoral-language" style="margin-top: 0.6rem;">Language</label>
                    <select id="sanctoral-language" name="language" data-role="language-select">
                        <option value="la">la</option>
                    </select>
                    <label class="pure-checkbox" style="margin-top: 0.8rem;">
                        <input type="checkbox" id="sanctoral-unique" name="unique_only">
                        Only show feasts unique to this diocese
                    </label>
                    <button type="submit" class="pure-button pure-button-primary" style="margin-top: 0.6rem;">Apply</button>
                </form>
                <form id="filters-translations" class="filter-form" data-type="translations" hidden>
                    <label for="trans-feast-type">Feast type</label>
                    <select id="trans-feast-type" name="feast_type">
                        <option value="">All</option>
                        <option value="temporal">Temporal</option>
                        <option value="sanctoral">Sanctoral</option>
                    </select>
                    <label for="trans-language" style="margin-top: 0.6rem;">Language</label>
                    <select id="trans-language" name="language" data-role="language-select" data-include-all="true">
                        <option value="">All</option>
                    </select>
                    <button type="submit" class="pure-button pure-button-primary" style="margin-top: 0.6rem;">Apply</button>
                </form>
                <form id="filters-dioceses" class="filter-form" data-type="dioceses" hidden>
                    <button type="submit" class="pure-button pure-button-primary" style="margin-top: 1.8rem;">Refresh</button>
                </form>
                <form id="filters-countries" class="filter-form" data-type="countries" hidden>
                    <button type="submit" class="pure-button pure-button-primary" style="margin-top: 1.8rem;">Refresh</button>
                </form>
            </div>
        </section>

        <section class="results">
            <div class="meta-bar" id="results-meta">
                <span>Select a table to begin.</span>
                <span></span>
            </div>
            <div class="table-wrapper" id="results-container">
                <p class="placeholder">No data loaded yet.</p>
            </div>
            <div class="pagination" id="pagination" hidden>
                <button class="pure-button" data-action="first">First</button>
                <button class="pure-button" data-action="prev">Previous</button>
                <span id="pagination-info"></span>
                <button class="pure-button" data-action="next">Next</button>
                <button class="pure-button" data-action="last">Last</button>
            </div>
        </section>
    </main>

    <script>
        (function() {
            const preloaded = {
                languages: {{ languages|tojson }},
                dioceses: {{ dioceses|tojson }}
            };
            
            const datasetSelect = document.getElementById('dataset-select');
            const metaBar = document.getElementById('results-meta');
            const resultsContainer = document.getElementById('results-container');
            const pagination = document.getElementById('pagination');
            const paginationInfo = document.getElementById('pagination-info');
            const filterForms = document.querySelectorAll('.filter-form');
            
            const state = {
                currentType: 'temporal',
                temporal: { language: 'la', page: 1 },
                sanctoral: { diocese: 'roman', language: 'la', unique_only: false, page: 1 },
                translations: { feast_type: '', language: '', page: 1 },
                dioceses: { page: 1 },
                countries: { page: 1 }
            };
            
            initialiseSelects();
            attachEventListeners();
            switchDataset('temporal');
            
            async function refreshLanguages() {
                try {
                    const response = await fetch('/api/languages');
                    if (!response.ok) return;
                    const langs = await response.json();
                    if (Array.isArray(langs) && langs.length) {
                        preloaded.languages = langs;
                        populateLanguageSelects();
                    }
                } catch (error) {
                    console.warn('Unable to refresh languages', error);
                }
            }
            refreshLanguages();
            
            async function refreshDioceses() {
                try {
                    const response = await fetch('/api/dioceses');
                    if (!response.ok) return;
                    const dioceses = await response.json();
                    if (Array.isArray(dioceses) && dioceses.length) {
                        preloaded.dioceses = dioceses;
                        populateDioceseSelects();
                    }
                } catch (error) {
                    console.warn('Unable to refresh dioceses', error);
                }
            }
            refreshDioceses();
            
            function initialiseSelects() {
                populateLanguageSelects();
                populateDioceseSelects();
            }
            
            function populateLanguageSelects() {
                const languages = Array.from(new Set(preloaded.languages || ['la'])).sort();
                document.querySelectorAll('[data-role="language-select"]').forEach(select => {
                    const includeAll = select.dataset.includeAll === 'true';
                    const currentValue = select.value;
                    select.innerHTML = '';
                    if (includeAll) {
                        select.appendChild(new Option('All', ''));
                    }
                    languages.forEach(lang => {
                        const option = new Option(lang, lang);
                        select.appendChild(option);
                    });
                    if (currentValue) {
                        select.value = currentValue;
                    }
                    if (!select.value && !includeAll && languages.length) {
                        select.value = languages[0];
                    }
                });
            }
            
            function populateDioceseSelects() {
                const dioceses = preloaded.dioceses || [];
                document.querySelectorAll('[data-role="diocese-select"]').forEach(select => {
                    const currentValue = select.value;
                    const firstOption = select.querySelector('option:first-child');
                    const placeholderValue = firstOption ? firstOption.value : '';
                    select.innerHTML = '';
                    if (firstOption) {
                        select.appendChild(new Option(firstOption.textContent, placeholderValue));
                    } else {
                        select.appendChild(new Option('Roman', 'roman'));
                    }
                    dioceses.forEach(diocese => {
                        const label = diocese.name_english || diocese.name_latin || diocese.code;
                        const option = new Option(`${diocese.code} — ${label}`, diocese.code || diocese.id);
                        option.dataset.id = diocese.id;
                        option.dataset.code = diocese.code;
                        option.dataset.name = label;
                        select.appendChild(option);
                    });
                    if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                        select.value = currentValue;
                    }
                });
            }
            
            function attachEventListeners() {
                datasetSelect.addEventListener('change', () => {
                    switchDataset(datasetSelect.value);
                });
                
                filterForms.forEach(form => {
                    form.addEventListener('submit', (event) => {
                        event.preventDefault();
                        applyFilters(form);
                    });
                });
                
                pagination.addEventListener('click', (event) => {
                    if (event.target.tagName !== 'BUTTON') return;
                    const action = event.target.dataset.action;
                    const { page, total_pages } = getCurrentPagination();
                    if (!page || !total_pages) return;
                    let targetPage = page;
                    if (action === 'first') targetPage = 1;
                    if (action === 'last') targetPage = total_pages;
                    if (action === 'prev' && page > 1) targetPage = page - 1;
                    if (action === 'next' && page < total_pages) targetPage = page + 1;
                    if (targetPage !== page) {
                        setCurrentPage(targetPage);
                        loadData();
                    }
                });
            }
            
            function switchDataset(type) {
                state.currentType = type;
                datasetSelect.value = type;
                filterForms.forEach(form => {
                    form.hidden = form.dataset.type !== type;
                });
                loadData();
            }
            
            function applyFilters(form) {
                const type = form.dataset.type;
                if (type === 'temporal') {
                    state.temporal.language = form.language.value || 'la';
                    state.temporal.page = 1;
                }
                if (type === 'sanctoral') {
                    state.sanctoral.diocese = form.diocese.value || 'roman';
                    state.sanctoral.language = form.language.value || 'la';
                    state.sanctoral.unique_only = form.unique_only.checked;
                    state.sanctoral.page = 1;
                }
                if (type === 'translations') {
                    state.translations.feast_type = form.feast_type.value || '';
                    state.translations.language = form.language.value || '';
                    state.translations.page = 1;
                }
                if (type === 'dioceses') {
                    state.dioceses.page = 1;
                }
                if (type === 'countries') {
                    state.countries.page = 1;
                }
                loadData();
            }
            
            function setCurrentPage(page) {
                state[state.currentType].page = page;
            }
            
            function getCurrentPagination() {
                return state[state.currentType].pagination || { page: 1, total_pages: 1 };
            }
            
            async function loadData() {
                showLoading();
                const { currentType } = state;
                let url = '';
                const perPage = 50;
                
                if (currentType === 'temporal') {
                    const { language, page } = state.temporal;
                    url = `/api/browse/temporal?page=${page || 1}&per_page=${perPage}&language=${encodeURIComponent(language)}`;
                } else if (currentType === 'sanctoral') {
                    const { diocese, unique_only, language, page } = state.sanctoral;
                    url = `/api/browse/sanctoral?page=${page || 1}&per_page=${perPage}&diocese=${encodeURIComponent(diocese)}&unique_only=${unique_only}&language=${encodeURIComponent(language)}`;
                } else if (currentType === 'dioceses') {
                    const { page } = state.dioceses;
                    url = `/api/browse/dioceses?page=${page || 1}&per_page=${perPage}`;
                } else if (currentType === 'countries') {
                    const { page } = state.countries;
                    url = `/api/browse/countries?page=${page || 1}&per_page=${perPage}`;
                } else if (currentType === 'translations') {
                    const { feast_type, language, page } = state.translations;
                    const params = new URLSearchParams({
                        page: String(page || 1),
                        per_page: String(perPage)
                    });
                    if (feast_type) params.append('feast_type', feast_type);
                    if (language) params.append('language', language);
                    url = `/api/browse/translations?${params.toString()}`;
                }
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error('Unable to fetch data');
                    }
                    const data = await response.json();
                    renderResults(data);
                } catch (error) {
                    showError(error.message || 'Unable to load data.');
                }
            }
            
            function showLoading() {
                resultsContainer.innerHTML = '<div class="loading">Loading…</div>';
                pagination.hidden = true;
                metaBar.innerHTML = '<span>Fetching data…</span><span></span>';
            }
            
            function showError(message) {
                resultsContainer.innerHTML = `<p class="placeholder">${message}</p>`;
                pagination.hidden = true;
                metaBar.innerHTML = `<span>${message}</span><span></span>`;
            }
            
            function renderResults(data) {
                const type = state.currentType;
                state[type].pagination = data.pagination || { page: 1, total_pages: 1, total: data.length || 0 };
                
                if (type === 'temporal') {
                    renderTemporalTable(data);
                } else if (type === 'sanctoral') {
                    renderSanctoralTable(data);
                } else if (type === 'dioceses') {
                    renderDiocesesTable(data);
                } else if (type === 'countries') {
                    renderCountriesTable(data);
                } else if (type === 'translations') {
                    renderTranslationsTable(data);
                }
            }
            
            function renderTemporalTable(data) {
                const { feasts = [], pagination: pageInfo, language } = data;
                updateMetaBar('Temporal feasts', pageInfo, `Language: ${language}`);
                resultsContainer.innerHTML = generateTemporalRows(feasts);
                updatePagination(pageInfo);
            }
            
            function generateTemporalRows(feasts) {
                if (!feasts.length) {
                    return '<p class="placeholder">No records for these filters.</p>';
                }
                let html = '<table class="pure-table pure-table-horizontal"><thead><tr><th>Name</th><th>Identifier</th><th>Rank</th><th>Color</th><th>Office</th></tr></thead><tbody>';
                feasts.forEach(feast => {
                    const rankLabel = feast.rank ? `${feast.rank[0]} — ${feast.rank[1]}` : 'n/a';
                    html += `
                        <tr>
                            <td>${escapeHtml(feast.name || '')}</td>
                            <td><code>${escapeHtml(feast.id)}</code></td>
                            <td><span class="badge rank-label">${rankLabel}</span></td>
                            <td>${escapeHtml(feast.color || '')}</td>
                            <td>${escapeHtml(feast.office_type || '')}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                return html;
            }
            
            function renderSanctoralTable(data) {
                const { feasts = [], pagination: pageInfo, diocese, unique_only, language } = data;
                const dioceseLabel = unique_only ? `Unique to ${diocese}` : `Diocese filter: ${diocese}`;
                updateMetaBar('Sanctoral feasts', pageInfo, `${dioceseLabel} · Language: ${language}`);
                if (!feasts.length) {
                    resultsContainer.innerHTML = '<p class="placeholder">No records for these filters.</p>';
                    updatePagination(pageInfo);
                    return;
                }
                let html = '<table class="pure-table pure-table-horizontal"><thead><tr><th>Date</th><th>Name</th><th>Feast ID</th><th>Source</th><th>Rank</th><th>Color</th></tr></thead><tbody>';
                feasts.forEach(feast => {
                    const date = feast.month && feast.day ? `${String(feast.month).padStart(2, '0')}-${String(feast.day).padStart(2, '0')}` : '';
                    const rankLabel = feast.rank ? feast.rank[1] : '';
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>${escapeHtml(feast.name || '')}</td>
                            <td>${escapeHtml(String(feast.id))}</td>
                            <td><span class="badge">${escapeHtml(feast.diocese_source || '')}</span></td>
                            <td>${escapeHtml(rankLabel)}</td>
                            <td>${escapeHtml(feast.color || '')}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                resultsContainer.innerHTML = html;
                updatePagination(pageInfo);
            }
            
            function renderDiocesesTable(data) {
                const { dioceses = [], pagination: pageInfo } = data;
                updateMetaBar('Dioceses', pageInfo);
                if (!dioceses.length) {
                    resultsContainer.innerHTML = '<p class="placeholder">No dioceses found.</p>';
                    updatePagination(pageInfo);
                    return;
                }
                let html = '<table class="pure-table pure-table-horizontal"><thead><tr><th>Code</th><th>Name (Latin)</th><th>Name (English)</th><th>Country</th></tr></thead><tbody>';
                dioceses.forEach(diocese => {
                    html += `
                        <tr>
                            <td><code>${escapeHtml(diocese.code)}</code></td>
                            <td>${escapeHtml(diocese.name_latin || '')}</td>
                            <td>${escapeHtml(diocese.name_english || '')}</td>
                            <td>${escapeHtml(diocese.country_name || 'Universal')}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                resultsContainer.innerHTML = html;
                updatePagination(pageInfo);
            }
            
            function renderCountriesTable(data) {
                const { countries = [], pagination: pageInfo } = data;
                updateMetaBar('Countries', pageInfo);
                if (!countries.length) {
                    resultsContainer.innerHTML = '<p class="placeholder">No countries found.</p>';
                    updatePagination(pageInfo);
                    return;
                }
                let html = '<table class="pure-table pure-table-horizontal"><thead><tr><th>Code</th><th>Name (Latin)</th><th>Name (English)</th></tr></thead><tbody>';
                countries.forEach(country => {
                    html += `
                        <tr>
                            <td><code>${escapeHtml(country.code)}</code></td>
                            <td>${escapeHtml(country.name_latin || '')}</td>
                            <td>${escapeHtml(country.name_english || '')}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                resultsContainer.innerHTML = html;
                updatePagination(pageInfo);
            }
            
            function renderTranslationsTable(data) {
                const { translations = [], pagination: pageInfo, feast_type, language } = data;
                const pieces = [];
                if (feast_type) pieces.push(`Type: ${feast_type}`);
                if (language) pieces.push(`Language: ${language}`);
                updateMetaBar('Translations', pageInfo, pieces.join(' · '));
                if (!translations.length) {
                    resultsContainer.innerHTML = '<p class="placeholder">No translations match these filters.</p>';
                    updatePagination(pageInfo);
                    return;
                }
                let html = '<table class="pure-table pure-table-horizontal"><thead><tr><th>Feast ID</th><th>Type</th><th>Language</th><th>Translation</th><th>Default?</th></tr></thead><tbody>';
                translations.forEach(trans => {
                    html += `
                        <tr>
                            <td>${escapeHtml(String(trans.feast_id))}</td>
                            <td><span class="badge">${escapeHtml(trans.feast_type)}</span></td>
                            <td>${escapeHtml(trans.language_code)}</td>
                            <td>${escapeHtml(trans.translation || '')}</td>
                            <td>${trans.is_default ? 'Yes' : ''}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                resultsContainer.innerHTML = html;
                updatePagination(pageInfo);
            }
            
            function updateMetaBar(title, pageInfo, extra) {
                const total = pageInfo ? pageInfo.total : 0;
                const pageText = pageInfo ? `Page ${pageInfo.page} of ${Math.max(pageInfo.total_pages || 1, 1)}` : '';
                const extraText = extra ? ` · ${extra}` : '';
                metaBar.innerHTML = `<span>${title} — ${total} records${extraText}</span><span>${pageText}</span>`;
            }
            
            function updatePagination(pageInfo) {
                if (!pageInfo || pageInfo.total_pages <= 1) {
                    pagination.hidden = true;
                    paginationInfo.textContent = '';
                    return;
                }
                pagination.hidden = false;
                paginationInfo.textContent = `Page ${pageInfo.page} of ${pageInfo.total_pages}`;
                const buttons = pagination.querySelectorAll('button');
                buttons.forEach(button => {
                    const action = button.dataset.action;
                    button.disabled = false;
                    if (action === 'first' || action === 'prev') {
                        button.disabled = pageInfo.page <= 1;
                    }
                    if (action === 'next' || action === 'last') {
                        button.disabled = pageInfo.page >= pageInfo.total_pages;
                    }
                });
            }
            
            function escapeHtml(input) {
                if (input === null || input === undefined) return '';
                return String(input)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;');
            }
        })();
    </script>
</body>
</html>
